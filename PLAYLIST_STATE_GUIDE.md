# 播放列表状态保存和恢复功能

## 功能概述

本应用新增了播放列表状态的自动保存和恢复功能，可以在以下情况下保持用户的播放状态：

- 应用关闭时自动保存当前播放状态
- 应用启动时自动恢复上次播放状态
- 播放列表、播放索引、播放模式、播放进度等都会被保存

## 保存的状态信息

保存的状态包括：

1. **播放列表** - 当前播放的所有歌曲
2. **当前播放索引** - 正在播放的歌曲在列表中的位置
3. **播放模式** - 列表循环、单曲循环、随机播放等
4. **播放进度** - 当前歌曲的播放位置（毫秒）
5. **播放状态** - 是否在播放中
6. **音量设置** - 当前音量大小

## 使用方式

### 自动保存

- 当播放列表发生变化时（添加/删除歌曲）
- 当播放模式切换时
- 当播放进度变化时（防抖保存，1秒后）
- 当应用关闭时

### 自动恢复

- 应用启动时会自动检查是否有保存的播放状态
- 如果有，会自动恢复播放列表和播放状态
- 如果上次退出时正在播放，会继续播放

### 手动控制

如果需要，可以通过以下方式手动控制：

```dart
// 手动保存播放状态
await audioPlayerService.savePlaylistState();

// 手动恢复播放状态
await audioPlayerService.restorePlaylistState();

// 检查是否有保存的播放状态
bool hasState = await AudioPlayerService.hasSavedPlaylistState();

// 清除保存的播放状态
await SettingsService.clearPlaylistState();
```

## 技术实现

### 数据存储

使用 `SharedPreferences` 存储播放状态，数据以 JSON 格式保存。

### 数据序列化

`Song` 类新增了 `toJson()` 和 `fromJson()` 方法，支持完整的序列化和反序列化。

### 防抖机制

为了避免频繁保存导致的性能问题，使用了防抖机制：
- 播放进度变化时使用1秒防抖
- 播放模式、播放列表变化时立即保存

## 注意事项

1. **文件路径有效性**：恢复播放时会检查文件路径是否存在，如果文件被删除或移动，该歌曲会被跳过
2. **权限问题**：确保应用有读取存储权限，否则可能无法恢复播放
3. **大列表性能**：对于大型播放列表，保存和恢复可能需要一些时间
4. **清理状态**：如果需要重置播放状态，可以在设置中提供清除选项

## 故障排除

### 状态没有保存

- 检查是否有存储权限
- 查看日志输出是否有错误信息
- 确认播放列表不为空

### 状态没有恢复

- 检查是否有保存的状态（使用 `hasSavedPlaylistState()`）
- 确认文件路径仍然有效
- 查看日志输出是否有错误信息

### 手动测试

可以通过以下步骤测试功能：

1. 播放几首歌曲
2. 切换播放模式
3. 调整播放进度
4. 关闭应用
5. 重新打开应用
6. 检查是否恢复了之前的状态