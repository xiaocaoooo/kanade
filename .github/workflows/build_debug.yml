name: Build Debug APK

# è§¦å‘æ¡ä»¶ï¼šå½“ä»£ç æ¨é€åˆ°ä»»æ„åˆ†æ”¯æˆ–åˆ›å»ºpull requestæ—¶
on:
  push:
    branches: [ '**' ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    # æ£€å‡ºä»£ç 
    - name: Checkout code
      uses: actions/checkout@v4
      
    # è®¾ç½®Flutterç¯å¢ƒ
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.29.3'
        channel: 'stable'
        cache: true  # å¯ç”¨ç¼“å­˜
        
    # è·å–Flutterä¾èµ–
    - name: Get dependencies
      run: flutter pub get
      
    # ç¼“å­˜ä¾èµ–
    - name: Cache Flutter dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.pub-cache
          .dart_tool/
        key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}
        restore-keys: |
          ${{ runner.os }}-flutter-
          
    # æ£€æŸ¥Flutterç¯å¢ƒ
    - name: Flutter doctor
      run: flutter doctor -v
      
    # æ£€æŸ¥ä»£ç æ ¼å¼
    - name: Check code formatting
      run: flutter format --set-exit-if-changed .
      
    # è¿è¡Œé™æ€åˆ†æ
    - name: Analyze code
      run: flutter analyze
      
    # è¿è¡Œæµ‹è¯•ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
    - name: Run tests
      run: flutter test
      continue-on-error: true  # å…è®¸æµ‹è¯•å¤±è´¥ï¼Œä½†ç»§ç»­æ„å»º
      
    # æ„å»ºDebug APK
    - name: Build Debug APK
      run: |
        flutter build apk --debug --verbose
        ls -la build/app/outputs/flutter-apk/
      
    # ä¸Šä¼ æ„å»ºäº§ç‰©
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: debug-apk-${{ github.sha }}
        path: build/app/outputs/flutter-apk/app-debug.apk
        retention-days: 14
        
    # ä¸Šä¼ æ„å»ºæ—¥å¿—
    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ github.sha }}
        path: |
          build/app/outputs/logs/
          flutter_*.log
        retention-days: 7
        
    # æ˜¾ç¤ºæ„å»ºç»“æœ
    - name: Build Summary
      run: |
        echo "ğŸ”¨ Build completed for commit: ${{ github.sha }}"
        echo "ğŸ“± Branch: ${{ github.ref }}"
        echo "ğŸ‘¤ Committer: ${{ github.actor }}"
        
    # å¦‚æœæ„å»ºæˆåŠŸï¼Œæ˜¾ç¤ºæˆåŠŸä¿¡æ¯
    - name: Build Success
      if: success()
      run: |
        echo "âœ… Debug APK build completed successfully!"
        echo "ğŸ“¦ APK file: build/app/outputs/flutter-apk/app-debug.apk"
        
    # å¦‚æœæ„å»ºå¤±è´¥ï¼Œæ˜¾ç¤ºå¤±è´¥ä¿¡æ¯
    - name: Build Failed
      if: failure()
      run: echo "âŒ Debug APK build failed!"
